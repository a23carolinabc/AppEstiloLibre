@page "/admin/usuarios/listado"
@layout LayoutAdministracion
@using Microsoft.AspNetCore.Authorization
@using EstiloLibreFront.Objetos.Administracion
@attribute [Authorize(Policy = CodigosPermisos.ADMIN)]

<PageTitle>Listado de Administradores - EstiloLibre</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Gestión de Administradores</MudText>

    <!-- Barra de búsqueda y acciones -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="4">
                <MudSelect @bind-Value="this._tipoBusqueda" 
                           Label="Buscar por" 
                           Variant="Variant.Outlined"
                           Dense="true">
                    <MudSelectItem Value="@("0")">Todos</MudSelectItem>
                    <MudSelectItem Value="@("1")">Nombre</MudSelectItem>
                    <MudSelectItem Value="@("2")">Login</MudSelectItem>
                    <MudSelectItem Value="@("3")">Email</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="5">
                <MudTextField @bind-Value="this._textoBusqueda" 
                              Label="Texto de búsqueda" 
                              Variant="Variant.Outlined"
                              Dense="true"
                              Immediate="true"
                              OnKeyUp="@OnKeyUpBusqueda" />
            </MudItem>
            <MudItem xs="12" sm="3" Class="d-flex align-center">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Search"
                           OnClick="BuscarUsuarios"
                           FullWidth="true">
                    Buscar
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Tabla de usuarios -->
    @if (this._cargando)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudTable Items="@this._usuarios" 
                  Hover="true" 
                  Breakpoint="Breakpoint.Sm"
                  Loading="@this._cargando"
                  Elevation="2"
                  Dense="true"
                  OnRowClick="@((TableRowClickEventArgs<UsuarioAdminResumenDTO> args) => Navigation.NavigateTo($"{URLsPantallas.AdminUsuarios}{args.Item.Id}"))">
            <HeaderContent>
                <MudTh>Foto</MudTh>
                <MudTh>Login</MudTh>
                <MudTh>Nombre</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Permisos</MudTh>
                <MudTh>Acciones</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Foto">
                    <MudAvatar Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.Person" />
                    </MudAvatar>
                </MudTd>
                <MudTd DataLabel="Login">@context.Login</MudTd>
                <MudTd DataLabel="Nombre">@context.NombreCompleto</MudTd>
                <MudTd DataLabel="Email">@context.CorreoE</MudTd>
                <MudTd DataLabel="Permisos">
                    @foreach (var permiso in context.PermisosAsignados)
                    {
                        <MudChip T="string" Size="Size.Small" 
                                 Color="@ObtenerColorPermiso(permiso)"
                                 Class="permiso-badge">
                            @permiso
                        </MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Acciones">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   Href="@($"{URLsPantallas.AdminUsuarios}{context.Id}")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="@(() => EliminarUsuario(context.Id))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No se encontraron administradores</MudText>
            </NoRecordsContent>
        </MudTable>
    }
</MudContainer>

@code {
    #region ***** DEPENDENCIAS *****

    [Inject]
    public required ServicioUsuariosAdmin ServicioUsuariosAdmin { get; set; }

    [Inject]
    public required ISnackbar Snackbar { get; set; }

    [Inject]
    public required IDialogService DialogService { get; set; }

    [Inject]
    public required NavigationManager Navigation { get; set; }

    #endregion

    #region ***** PARÁMETROS *****
    #endregion

    #region ***** PROPIEDADES PRIVADAS *****

    private List<UsuarioAdminResumenDTO> _usuarios = new();
    private bool _cargando = false;
    private string _tipoBusqueda = "0";
    private string _textoBusqueda = string.Empty;

    #endregion

    #region ***** MÉTODOS PÚBLICOS *****

    protected override async Task OnInitializedAsync()
    {
        await this.CargarUsuarios();
    }

    #endregion

    #region ***** MÉTODOS PRIVADOS *****

    private async Task CargarUsuarios()
    {
        try
        {
            this._cargando = true;
            this._usuarios = await this.ServicioUsuariosAdmin.GetListado(
                string.IsNullOrWhiteSpace(this._textoBusqueda) ? null : this._textoBusqueda,
                this._tipoBusqueda
            );
        }
        catch (Exception ex)
        {
            this.Snackbar.Add($"Error al cargar usuarios: {ex.Message}", Severity.Error);
        }
        finally
        {
            this._cargando = false;
        }
    }

    private async Task BuscarUsuarios()
    {
        await this.CargarUsuarios();
    }

    private async Task OnKeyUpBusqueda(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await this.BuscarUsuarios();
        }
    }

    private async Task EliminarUsuario(int iUsuarioId)
    {
        bool? confirmado;

        confirmado = await this.DialogService.ShowMessageBox(
            "Confirmar eliminación",
            "¿Está seguro de que desea eliminar este administrador?",
            yesText: "Eliminar",
            cancelText: "Cancelar"
        );

        if (confirmado == true)
        {
            try
            {
                await this.ServicioUsuariosAdmin.Delete(iUsuarioId);
                this.Snackbar.Add("Administrador eliminado correctamente", Severity.Success);
                await this.CargarUsuarios();
            }
            catch (Exception ex)
            {
                this.Snackbar.Add($"Error al eliminar: {ex.Message}", Severity.Error);
            }
        }
    }

    private Color ObtenerColorPermiso(string permiso)
    {
        return permiso switch
        {
            "PLUS" => Color.Success,
            "ADMIN" => Color.Primary,
            _ => Color.Default
        };
    }

    #endregion
}
