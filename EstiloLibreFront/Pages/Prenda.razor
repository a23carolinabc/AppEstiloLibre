@layout MainLayout
@page "/prendas/"
@page "/prendas/{Id:int}"

<PageTitle>@Traductor["PageTitle"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
    <MudText Typo="Typo.h4" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.AddCircle" Class="mr-2" />
        @Traductor["lblCrearNuevaPrenda"]
    </MudText>

    @if (this._prendaData == null)
    {
        <!-- ERROR AL CARGAR DATOS -->
        <MudAlert Severity="Severity.Error">@TraductorErrores["ERR_CargaDatosIniciales"]</MudAlert>
    }
    else
    {
        <EditForm Model="@this._prenda" OnValidSubmit="this.Guardar">
            <DataAnnotationsValidator />

            <!-- SELECCIÓN DE LA IMAGEN -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Image" Class="mr-2" />
                            @Traductor["lblFotoPrenda"]
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>

                    <InputFile id="fileInput"
                               OnChange="this.CargarImagen"
                               accept="image/*"
                               class="d-none" />

                    @if (this._bProcesandoImagen)
                    {
                        <!-- CÍRCULO DE CARGAR MIENTRAS SE PROCESA LA IMAGEN -->
                        <div class="text-center pa-4">
                            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
                            <MudText Typo="Typo.body1" Class="mt-2">
                                @Traductor["lblEsperaEliminacionFondo"]
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @Traductor["lblAvisoEspera"]
                            </MudText>
                        </div>
                    }
                    else
                    {
                        <!-- BOTÓN SELECCIÓN DE IMAGEN -->
                        <MudButton HtmlTag="label"
                                   Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                   for="fileInput"
                                   FullWidth="true">
                            @(string.IsNullOrEmpty(this._strImagenPreview) 
                                                    ? Traductor["btnSeleccionarImagen"] 
                                                    : Traductor["btnCambiarImagen"])
                        </MudButton>

                        <!-- Preview de la imagen -->
                        @if (!string.IsNullOrEmpty(this._strImagenPreview))
                        {
                            <MudPaper Class="mt-4 pa-2 text-center" Style="background-color: #f5f5f5;">
                                <MudImage Src="@this._strImagenPreview"
                                          Alt="Vista previa"
                                          Style="max-width: 100%; max-height: 400px; border: 2px solid #ddd; border-radius: 8px;" />
                                <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Success">
                                    ✓ Fondo eliminado correctamente
                                </MudText>
                            </MudPaper>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Class="mt-2">
                                Selecciona una imagen de tu prenda. El fondo se eliminará automáticamente.
                            </MudAlert>
                        }
                    }

                </MudCardContent>
            </MudCard>

            <!-- INFORMACIÓN BÁSICA -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                            Información Básica
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>

                    <!-- Color -->
                    <MudSelect @bind-Value="this._prenda.ColorId"
                               Label="Color *"
                               Variant="Variant.Outlined"
                               Class="mb-3"
                               Required="true">
                        <MudSelectItem Value="0">Seleccione un color</MudSelectItem>
                        @if (this._prendaData.Colores != null)
                        {
                            @foreach (var color in this._prendaData.Colores)
                            {
                                <MudSelectItem Value="@color.Id">@color.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <!-- Categoría -->
                    <MudSelect @bind-Value="this._prenda.CategoriaId"
                               Label="Categoría *"
                               Variant="Variant.Outlined"
                               Class="mb-3"
                               Required="true">
                        <MudSelectItem Value="0">Seleccione una categoría</MudSelectItem>
                        @if (this._prendaData.Categorias != null)
                        {
                            @foreach (var categoria in this._prendaData.Categorias)
                            {
                                <MudSelectItem Value="@categoria.Id">@categoria.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <!-- Talla -->
                    <MudSelect @bind-Value="this._prenda.TallaId"
                               Label="Talla *"
                               Variant="Variant.Outlined"
                               Class="mb-3"
                               Required="true">
                        <MudSelectItem Value="0">Seleccione una talla</MudSelectItem>
                        @if (this._prendaData.Tallas != null)
                        {
                            @foreach (var talla in this._prendaData.Tallas)
                            {
                                <MudSelectItem Value="@talla.Id">@talla.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <!-- Estado -->
                    <MudSelect @bind-Value="this._prenda.EstadoId"
                               Label="Estado *"
                               Variant="Variant.Outlined"
                               Class="mb-3"
                               Required="true">
                        <MudSelectItem Value="0">Seleccione un estado</MudSelectItem>
                        @if (this._prendaData.Estados != null)
                        {
                            @foreach (var estado in this._prendaData.Estados)
                            {
                                <MudSelectItem Value="@estado.Id">@estado.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <!-- Material -->
                    <MudSelect @bind-Value="this._prenda.MaterialId"
                               Label="Material *"
                               Variant="Variant.Outlined"
                               Class="mb-3"
                               Required="true">
                        <MudSelectItem Value="0">Seleccione un material</MudSelectItem>
                        @if (this._prendaData.Materiales != null)
                        {
                            @foreach (var material in this._prendaData.Materiales)
                            {
                                <MudSelectItem Value="@material.Id">@material.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>

                </MudCardContent>
            </MudCard>

            <!-- INFORMACIÓN ADICIONAL (OPCIONAL) -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.MoreHoriz" Class="mr-2" />
                            Información Adicional (Opcional)
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>

                    <!-- Marca -->
                    <MudSelect T="int?" @bind-Value="this._prenda.MarcaId"
                               Label="Marca (Opcional)"
                               Variant="Variant.Outlined"
                               Class="mb-3">
                        <MudSelectItem T="int?" Value="null">Sin marca</MudSelectItem>
                        @if (this._prendaData.Marcas != null)
                        {
                            @foreach (var marca in this._prendaData.Marcas)
                            {
                                <MudSelectItem T="int?" Value="@marca.Id">@marca.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <!-- Estación -->
                    <MudSelect T="int?" @bind-Value="this._prenda.EstacionId"
                               Label="Estación (Opcional)"
                               Variant="Variant.Outlined"
                               Class="mb-3">
                        <MudSelectItem T="int?" Value="null">Sin estacion</MudSelectItem>
                        @if (this._prendaData.Estaciones != null)
                        {
                            @foreach (var estacion in this._prendaData.Estaciones)
                            {
                                <MudSelectItem T="int?" Value="@estacion.Id">@estacion.Nombre</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <!-- Precio -->
                    <MudNumericField @bind-Value="this._prenda.Precio"
                                     Label="Precio (€)"
                                     Variant="Variant.Outlined"
                                     Min="0"
                                     Class="mb-3" />

                    <!-- Enlace de Compra -->
                    <MudTextField @bind-Value="this._prenda.EnlaceCompra"
                                  Label="Enlace de Compra (URL)"
                                  Variant="Variant.Outlined"
                                  Class="mb-3" />

                    <!-- Fecha de Compra -->
                    <MudDatePicker @bind-Date="this._prenda.FechaCompra"
                                   Label="Fecha de Compra"
                                   Variant="Variant.Outlined" />

                </MudCardContent>
            </MudCard>

            <!-- BOTONES DE ACCIÓN -->
            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => this.ServicioNavegacion.NavegarA("/"))">
                    Cancelar
                </MudButton>

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           Disabled="@(this._bGuardando || string.IsNullOrEmpty(this._strImagenPreview))">
                    @(this._bGuardando ? "Guardando..." : "Guardar Prenda")
                </MudButton>
            </MudStack>

        </EditForm>
    }
</MudContainer>

@code {

    #region ***** INYECCIONES *****
    [Inject]
    public required ServicioDatosContexto ServicioDatosContexto { get; set; }
    [Inject]
    public required ServicioPrendas ServicioPrendas { get; set; }
    [Inject]
    public required ServicioNavegacion ServicioNavegacion { get; set; }
    [Inject]
    public required ISnackbar ServicioNotificacion { get; set; }
    [Inject]
    public required IJSRuntime ServicioJS { get; set; }
    [Inject]
    public required IStringLocalizer<TrErrores> TraductorErrores { get; set; }
    [Inject]
    public required IStringLocalizer<TrPrendas> Traductor { get; set; }
    [Inject]
    public required IStringLocalizer<TrGeneral> TraductorGeneral { get; set; }
    [Inject]
    public required IServicioCargador ServicioCargador { get; set; }
    #endregion

    #region ***** PARAMETROS *****
    [Parameter]
    public int Id { get; set; }
    #endregion

    #region ***** PROPIEDADES PRIVADAS *****

    private PrendaData? _prendaData = null;
    private PrendaDTO _prenda = new();
    private string _strImagenPreview = string.Empty;
    private bool _bProcesandoImagen = false;
    private bool _bGuardando = false;

    #endregion

    #region ***** MÉTODOS PÚBLICOS *****

    protected override async Task OnInitializedAsync()
    {
        // this.ServicioCargador.Abrir();
        try
        {
            // Cargar datos necesarios para el formulario.
            if(this.Id > 0)
            {
                this._prendaData = await this.ServicioPrendas.ShowData(this.Id);
            } else
            {                
                this._prendaData = await this.ServicioPrendas.AddNew();
            }

            //Iniciamos objeto prenda.
            if (this._prendaData == null)
            {
                this.ServicioNotificacion.Add(this.TraductorErrores["ERR_CargaDatosIniciales"], Severity.Error);
            }
            else
            {
                this._prenda = this._prendaData.Prenda?? new();
                if (!string.IsNullOrEmpty(this._prenda.ImagenBase64))
                {
                    this._strImagenPreview = this._prenda.ImagenBase64;
                }
            }
        }
        catch (Exception ex)
        {
            this.ServicioNotificacion.Add(this.TraductorErrores["ERR_CargaDatosIniciales"], Severity.Error);
        }
        finally
        {
            // this.ServicioCargador.Cerrar();
        }
    }

    #endregion

    #region ***** MÉTODOS PRIVADOS *****

    private async Task CargarImagen(InputFileChangeEventArgs e)
    {
        IBrowserFile archivo;
        byte[] imagenBytes;
        string imagenBase64;
        string imagenFinalBase64;
        CancellationTokenSource tokenTiempoCancelacionMetodo;

        try
        {
            archivo = e.File;

            //Indicar espera al usuario.
            this._bProcesandoImagen = true;
            StateHasChanged();
                      
            // Validar tamaño (máximo 10MB).
            if (archivo.Size > 10 * 1024 * 1024)
            {
                this.ServicioNotificacion.Add(this.TraductorErrores["ERR_ImagenDemasiadoGrande"], Severity.Warning);
                this._bProcesandoImagen = false;
                StateHasChanged();
                return;
            }

            this.ServicioNotificacion.Add(this.Traductor["NTF_ProcesandoImagen"], Severity.Info);

            // Leer imagen y pasar a bytes[].           
            using (var stream = archivo.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024))
            using (var ms = new MemoryStream())
            {
                await stream.CopyToAsync(ms);
                imagenBytes = ms.ToArray();
            }

            // Convertir a base64.
            imagenBase64 = $"data:{archivo.ContentType};base64,{Convert.ToBase64String(imagenBytes)}";

            // Definir tiempo máximo de procesamiento.
            tokenTiempoCancelacionMetodo = new CancellationTokenSource(TimeSpan.FromSeconds(300)); // 60 segundos timeout

            // Usar función js para eliminar el fondo.
            imagenFinalBase64 = await this.ServicioJS.InvokeAsync<string>(
                    "eliminarFondo",
                    tokenTiempoCancelacionMetodo.Token,
                    imagenBase64
                );

            // Guardar resultado,
            if (!string.IsNullOrEmpty(imagenFinalBase64))
            {
                // Para preview.
                this._strImagenPreview = imagenFinalBase64;

                // Para enviar al servidor.
                this._prenda.ImagenBase64 = imagenFinalBase64.Contains(",") ? imagenFinalBase64.Split(',')[1] : imagenFinalBase64;

                //Notificar al usuario.
                this.ServicioNotificacion.Add(this.Traductor["NTF_FondoEliminadoCorrectamente"], Severity.Success);
            }
            else
            {
                this.ServicioNotificacion.Add(this.TraductorErrores["ERR_FondoNoEliminado"], Severity.Error);
                throw new Exception();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error detallado: {ex}");

            // Limpiar preview.
            this._strImagenPreview = string.Empty;
            this._prenda.ImagenBase64 = string.Empty;
        }
        finally
        {
            this._bProcesandoImagen = false;
            StateHasChanged();
        }
    }

    private async Task Guardar()
    {
        int iPrendaId;
        bool bFormValido;

        try
        {
            //Validar formulario.
            bFormValido = this.Validar();
            if (!bFormValido) return;

            //Notificar al usuario.
            this._bGuardando = true;
            this.ServicioNotificacion.Add(this.TraductorGeneral["NTF_Guardando"], Severity.Info);

            // Enviar al servidor
            iPrendaId = await this.ServicioPrendas.SaveData(this._prenda);

            //Notificar al usuario el guardado.
            this.ServicioNotificacion.Add(this.TraductorGeneral["NTF_Guardado"], Severity.Success);
        }
        catch (Exception ex)
        {
            this.ServicioNotificacion.Add(this.TraductorErrores["ERR_Guardado"], Severity.Error);
            Console.WriteLine($"Error detallado: {ex}");
        }
        finally
        {
            this._bGuardando = false;
        }
    }

    private bool Validar()
    {
        if (string.IsNullOrEmpty(this._prenda.ImagenBase64))
        {
            this.ServicioNotificacion.Add(this.TraductorErrores["ERR_AvisoSubirImagen"], Severity.Warning);
            return false;
        }
        if (this._prenda.ColorId <= 0 ||
                this._prenda.CategoriaId <= 0 ||
                this._prenda.EstadoId <= 0 ||
                this._prenda.TallaId <= 0 ||
                this._prenda.MaterialId <= 0)
        {
            this.ServicioNotificacion.Add(this.TraductorErrores["ERR_RellenarCamposObligatorios"], Severity.Warning);
            return false;
        }
        return true;
    }

    #endregion
}