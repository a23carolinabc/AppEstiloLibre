@page "/prendas/"
@page "/prendas/{Id:int}"
@layout MainLayout

<PageTitle>@(this.Id > 0 ? "Editar prenda" : "Crear prenda")</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        @(this.Id > 0 ? "Editar prenda" : "Crear prenda")
    </MudText>

    @if (this._prendaData == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <EditForm Model="@this._prenda" OnValidSubmit="this.Guardar">
            <DataAnnotationsValidator />

            <!-- SELECCIÓN DE LA IMAGEN -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Image" Class="mr-2" />
                            Foto de la prenda
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" sm="6" Class="d-flex flex-column align-center">
                            @if (string.IsNullOrEmpty(this._strImagenPreview))
                            {
                                <MudPaper Elevation="0" Class="pa-8 text-center" Style="border: 2px dashed #e0e0e0; width: 100%; min-height: 150px;">
                                    <MudIcon Icon="@Icons.Material.Filled.AddPhotoAlternate" Size="Size.Large" Color="Color.Default" Style="font-size: 80px;" />
                                    <MudText Typo="Typo.h6" Class="mt-4">
                                        Sin imagen
                                    </MudText>
                                </MudPaper>
                            }
                            else
                            {
                                <MudImage Src="@($"{this._strImagenPreview}")"
                                          Alt="@Traductor["lblPreviewImagen"]"
                                          Elevation="3"
                                          Class="rounded"
                                          Style="max-width: 100%; max-height: 200px; object-fit: contain;" />
                            }
                        </MudItem>
                    </MudGrid>
                    <MudGrid>
                        <MudItem xs="12" sm="6" Class="d-flex flex-column justify-center">
                            <InputFile id="fileInput"
                                       OnChange="this.CargarImagen"
                                       hidden
                                       accept=".jpg,.jpeg,.png" />

                            <MudButton HtmlTag="label"
                                       Variant="Variant.Filled"
                                       Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.CloudUpload"
                                       FullWidth="true"
                                       for="fileInput"
                                       Disabled="@this._bProcesandoImagen"
                                       Class="mb-3">
                                Seleccione una imagen
                            </MudButton>

                            @if (this._bProcesandoImagen)
                            {
                                <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Class="mb-3" />
                                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Default">
                                    Procesando...
                                </MudText>
                            }
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- INFORMACIÓN BÁSICA EN 2 COLUMNAS -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                            Información esencial
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <!-- Color -->
                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="this._prenda.ColorId"
                                       Label="Color"
                                       Variant="Variant.Outlined"
                                       Required="true">
                                <MudSelectItem Value="0">Seleccione un color</MudSelectItem>
                                @if (this._prendaData.Colores != null)
                                {
                                    @foreach (var color in this._prendaData.Colores)
                                    {
                                        <MudSelectItem Value="@color.Id">@color.Nombre</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Material -->
                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="this._prenda.MaterialId"
                                       Label="Material"
                                       Variant="Variant.Outlined"
                                       Required="true">
                                <MudSelectItem Value="0">Seleccione un material</MudSelectItem>
                                @if (this._prendaData.Materiales != null)
                                {
                                    @foreach (var material in this._prendaData.Materiales)
                                    {
                                        <MudSelectItem Value="@material.Id">@material.Nombre</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Categoría -->
                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="this._prenda.CategoriaId"
                                       Label="Categoría"
                                       Variant="Variant.Outlined"
                                       Required="true">
                                <MudSelectItem Value="0">Seleccione una categoría</MudSelectItem>
                                @if (this._prendaData.Categorias != null)
                                {
                                    @foreach (var categoria in this._prendaData.Categorias)
                                    {
                                        <MudSelectItem Value="@categoria.Id">@categoria.Nombre</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Talla -->
                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="this._prenda.TallaId"
                                       Label="Talla"
                                       Variant="Variant.Outlined"
                                       Required="true">
                                <MudSelectItem Value="0">Seleccione una talla</MudSelectItem>
                                @if (this._prendaData.Tallas != null)
                                {
                                    @foreach (var talla in this._prendaData.Tallas)
                                    {
                                        <MudSelectItem Value="@talla.Id">@talla.Nombre</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Estado -->
                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="this._prenda.EstadoId"
                                       Label="Estado"
                                       Variant="Variant.Outlined"
                                       Required="true">
                                <MudSelectItem Value="0">Seleccione un estado</MudSelectItem>
                                @if (this._prendaData.Estados != null)
                                {
                                    @foreach (var estado in this._prendaData.Estados)
                                    {
                                        <MudSelectItem Value="@estado.Id">@estado.Nombre</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Marca -->
                        <MudItem xs="12" sm="6">
                            <MudSelect T="int?" @bind-Value="this._prenda.MarcaId"
                                       Label="Marca"
                                       Variant="Variant.Outlined">
                                <MudSelectItem T="int?" Value="null">Seleccione una marca</MudSelectItem>
                                @if (this._prendaData.Marcas != null)
                                {
                                    @foreach (var marca in this._prendaData.Marcas)
                                    {
                                        <MudSelectItem T="int?" Value="@marca.Id">@marca.Nombre</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- INFORMACIÓN ADICIONAL EN 2 COLUMNAS -->
            <MudCard Class="mb-4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.MoreHoriz" Class="mr-2" />
                            Información adicional
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <!-- Estación -->
                        <MudItem xs="12" sm="6">
                            <MudSelect T="int?" @bind-Value="this._prenda.EstacionId"
                                       Label="Estación"
                                       Variant="Variant.Outlined">
                                <MudSelectItem T="int?" Value="null">Seleccione una estación</MudSelectItem>
                                @if (this._prendaData.Estaciones != null)
                                {
                                    @foreach (var estacion in this._prendaData.Estaciones)
                                    {
                                        <MudSelectItem T="int?" Value="@estacion.Id">@estacion.Nombre</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>

                        <!-- Precio -->
                        <MudItem xs="12" sm="6">
                            <MudNumericField @bind-Value="this._prenda.Precio"
                                             Label="Precio"
                                             Variant="Variant.Outlined"
                                             Min="0"
                                             Adornment="Adornment.Start"
                                             AdornmentText="€" />
                        </MudItem>

                        <!-- Enlace de Compra -->
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="this._prenda.EnlaceCompra"
                                          Label="Enlace de compra"
                                          Variant="Variant.Outlined" />
                        </MudItem>

                        <!-- Fecha de Compra -->
                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="this._prenda.FechaCompra"
                                           Label="Fecha de compra"
                                           Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- BOTONES DE ACCIÓN -->
            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => this.ServicioNavegacion.NavegarA(URLsPantallas.ListadoPrendas))">
                    Cancelar
                </MudButton>

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Save"
                           Disabled="@(this._bGuardando || string.IsNullOrEmpty(this._strImagenPreview))">
                    @(this._bGuardando ? "Guardando..." : "Guardar prenda")
                </MudButton>
            </MudStack>

        </EditForm>
    }
</MudContainer>

@code {

    #region ***** INYECCIONES *****
    [Inject]
    public required ServicioDatosContexto ServicioDatosContexto { get; set; }
    [Inject]
    public required ServicioPrendas ServicioPrendas { get; set; }
    [Inject]
    public required ServicioNavegacion ServicioNavegacion { get; set; }
    [Inject]
    public required ISnackbar ServicioNotificacion { get; set; }
    [Inject]
    public required IJSRuntime ServicioJS { get; set; }
    [Inject]
    public required IStringLocalizer<TrErrores> TraductorErrores { get; set; }
    [Inject]
    public required IStringLocalizer<TrPrendas> Traductor { get; set; }
    [Inject]
    public required IStringLocalizer<TrGeneral> TraductorGeneral { get; set; }
    [Inject]
    public required IServicioCargador ServicioCargador { get; set; }
    #endregion

    #region ***** PARAMETROS *****
    [Parameter]
    public int Id { get; set; }
    #endregion

    #region ***** PROPIEDADES PRIVADAS *****

    private PrendaData? _prendaData = null;
    private PrendaDTO _prenda = new();
    private string _strImagenPreview = string.Empty;
    private bool _bProcesandoImagen = false;
    private bool _bGuardando = false;

    #endregion

    #region ***** MÉTODOS PÚBLICOS *****

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if(this.Id > 0)
            {
                this._prendaData = await this.ServicioPrendas.ShowData(this.Id);
            } else
            {                
                this._prendaData = await this.ServicioPrendas.AddNew();
            }

            if (this._prendaData == null)
            {
                this.ServicioNotificacion.Add(this.TraductorErrores["ERR_CargaDatosIniciales"], Severity.Error);
            }
            else
            {
                this._prenda = this._prendaData.Prenda?? new();
                if (!string.IsNullOrEmpty(this._prenda.ImagenBase64))
                {
                    this._strImagenPreview = this._prenda.ImagenBase64;
                }
            }
        }
        catch (Exception ex)
        {
            this.ServicioNotificacion.Add(this.TraductorErrores["ERR_CargaDatosIniciales"], Severity.Error);
        }
    }

    #endregion

    #region ***** MÉTODOS PRIVADOS *****

    private async Task CargarImagen(InputFileChangeEventArgs e)
    {
        IBrowserFile archivo;
        byte[] imagenBytes;
        string imagenBase64;
        string imagenFinalBase64;
        CancellationTokenSource tokenTiempoCancelacionMetodo;

        try
        {
            archivo = e.File;

            this._bProcesandoImagen = true;
            StateHasChanged();
                      
            if (archivo.Size > 10 * 1024 * 1024)
            {
                this.ServicioNotificacion.Add("Imagen demasiado grande", Severity.Warning);
                this._bProcesandoImagen = false;
                StateHasChanged();
                return;
            }

            this.ServicioNotificacion.Add("Procesando imagen...", Severity.Info);

            using (var stream = archivo.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024))
            using (var ms = new MemoryStream())
            {
                await stream.CopyToAsync(ms);
                imagenBytes = ms.ToArray();
            }

            imagenBase64 = $"data:{archivo.ContentType};base64,{Convert.ToBase64String(imagenBytes)}";

            tokenTiempoCancelacionMetodo = new CancellationTokenSource(TimeSpan.FromSeconds(300));

            imagenFinalBase64 = await this.ServicioJS.InvokeAsync<string>(
                    "eliminarFondo",
                    tokenTiempoCancelacionMetodo.Token,
                    imagenBase64
                );

            if (!string.IsNullOrEmpty(imagenFinalBase64))
            {
                this._strImagenPreview = imagenFinalBase64;
                this._prenda.ImagenBase64 = imagenFinalBase64.Contains(",") ? imagenFinalBase64.Split(',')[1] : imagenFinalBase64;
                this.ServicioNotificacion.Add("Fondo eliminado correctamente", Severity.Success);
            }
            else
            {
                this.ServicioNotificacion.Add("Fallo en la eliminación del fondo", Severity.Error);
                throw new Exception();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error detallado: {ex}");
            this._strImagenPreview = string.Empty;
            this._prenda.ImagenBase64 = string.Empty;
        }
        finally
        {
            this._bProcesandoImagen = false;
            StateHasChanged();
        }
    }

    private async Task Guardar()
    {
        int iPrendaId;
        bool bFormValido;

        try
        {
            bFormValido = this.Validar();
            if (!bFormValido) return;

            this._bGuardando = true;
            this.ServicioNotificacion.Add("Guardando...", Severity.Info);

            iPrendaId = await this.ServicioPrendas.SaveData(this._prenda);

            this.ServicioNotificacion.Add("Guardado!", Severity.Success);
        }
        catch (Exception ex)
        {
            this.ServicioNotificacion.Add("Error en el guardado", Severity.Error);
            Console.WriteLine($"Error detallado: {ex}");
        }
        finally
        {
            this._bGuardando = false;
        }
    }

    private bool Validar()
    {
        if (string.IsNullOrEmpty(this._prenda.ImagenBase64))
        {
            this.ServicioNotificacion.Add("Suba una imagen", Severity.Warning);
            return false;
        }
        if (this._prenda.ColorId <= 0 ||
                this._prenda.CategoriaId <= 0 ||
                this._prenda.EstadoId <= 0 ||
                this._prenda.TallaId <= 0 ||
                this._prenda.MaterialId <= 0)
        {
            this.ServicioNotificacion.Add(this.TraductorErrores["ERR_RellenarCamposObligatorios"], Severity.Warning);
            return false;
        }
        return true;
    }

    #endregion
}
